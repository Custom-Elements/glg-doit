<link rel="import" href="../node_modules/ui-typeahead/src/ui-typeahead.html">
<link rel="import" href="../node_modules/ui-check/src/ui-check.html">
<link rel="import" href="../node_modules/ui-input/src/ui-input.html">
<link rel="import" href="../node_modules/ui-form/src/ui-form.html">
<link rel="import" href="../node_modules/glg-current-user/src/glg-avatar.html">
<link rel="import" href="../node_modules/ui-markdown/src/ui-markdown.html">
<link rel="import" href="../node_modules/ui-preview/src/ui-preview.html">
<polymer-element name="glg-task" attributes="task coworkers username">
<template>
  <core-ajax
    id="coworkers"
    auto
    method="POST"
    url="https://services.glgresearch.com/cerca/employees/_search"
    body='{"query":{"match":{"name":"balla"}}}'
    handleAs="json"
    withCredentials=true
    on-core-response="{{coworkersResponse}}"></core-ajax>
  <link rel="stylesheet" href="../node_modules/ui-fonts/node_modules/ui-font-awesome/icons.less">
  <link rel="stylesheet" type="text/css" href="./glg-task.less">
  <ui-preview on-expanded="{{startEditing}}" on-change="{{taskUpdate}}">
    <preview>
      <row spaced padded>
        <ui-check padded value="{{task.done}}" on-change="{{moveBetweenViews}}"></ui-check>
        <column fill>
          <ui-markdown value="{{task.what}}">
          </ui-markdown>
          <row centered>
            <template if="{{delegatedOut(task)}}">
              To&nbsp;<glg-avatar username="{{task.delegated}}"></glg-avatar>&nbsp;
            </template>
            <template if="{{delegatedToMe(task)}}">
              For&nbsp;<glg-avatar username="{{task.who}}"></glg-avatar>&nbsp;
            </template>
            <span class="{{due(task.when)}}">{{task.when | relativeDate}}</span>
          </row>
        </column>
      </row>
    </preview>
    <full>
      <row spaced padded>
        <ui-check padded value="{{task.done}}" on-change="{{moveBetweenViews}}"></ui-check>
        <column spaced fill>
          <ui-input id="what" multiline="2" value="{{task.what}}">
            <preview>
              <ui-markdown value="{{task.what}}">
              </ui-markdown>
            </preview>
          </ui-input>
          <ui-input placeholder="When?" type="date" value="{{task.when}}" class="{{due(task.when)}}">
            <preview>{{task.when | relativeDate}}</preview>
            <icon calendar></icon>
          </ui-input>
          <template if="{{delegatedToMe(task)}}">
            <row centered>For&nbsp;<glg-avatar username="{{task.who}}"></glg-avatar></row>
          </template>
          <ui-typeahead  placeholder="Delegate To?" value="{{task.delegated}}" valueFilter="{{username}}" on-inputchange="{{searchCoworkers}}" on-change="{{moveBetweenViews}}" >
            <icon user></icon>
            <template value>
              <value>
                <glg-avatar username="{{}}"></glg-avatar>
              </value>
            </template>
            <template repeat="{{coworkers}}">
              <ui-typeahead-item>
                <glg-avatar username="{{loginName}}"></glg-avatar>
                <span>{{name}}</span>
              </ui-typeahead-item>
            </template>
          </ui-typeahead>
        </column>
      </row>
    </full>
  </ui-preview>
</template>
<script src="./glg-task.litcoffee"></script>
</polymer-element>
