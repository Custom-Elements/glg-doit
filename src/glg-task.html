<link rel="import" href="../node_modules/ui-typeahead/src/ui-typeahead.html">
<link rel="import" href="../node_modules/ui-check/src/ui-check.html">
<link rel="import" href="../node_modules/ui-input/src/ui-input.html">
<link rel="import" href="../node_modules/ui-form/src/ui-form.html">
<link rel="import" href="../node_modules/glg-current-user/src/glg-avatar.html">
<link rel="import" href="../node_modules/ui-markdown/src/ui-markdown.html">
<link rel="import" href="../node_modules/ui-preview/src/ui-preview.html">
<link rel="import" href="../node_modules/ui-button/src/ui-button.html">
<polymer-element name="glg-task" attributes="task coworkers username">
<template>
  <core-ajax
    id="coworkers"
    auto
    method="POST"
    url="https://services.glgresearch.com/cerca/employees/_search"
    body='{"query":{"match":{"name":"balla"}}}'
    handleAs="json"
    withCredentials=true
    on-core-response="{{coworkersResponse}}"></core-ajax>
  <link rel="stylesheet" href="../node_modules/ui-fonts/node_modules/ui-font-awesome/icons.less">
  <link rel="stylesheet" type="text/css" href="./glg-task.less">
  <ui-preview id="preview" on-expanded="{{focus}}">
    <preview>
      <ui-form>
        <row spaced padded>
          <column>
            <ui-check value="{{task.done}}" on-click="{{doneTodo}}"></ui-check>
          </column>
          <column fill>
            <ui-markdown value="{{task.what}}">
            </ui-markdown>
            <row centered>
              <template if="{{delegatedOut(task)}}">
                To&nbsp;<glg-avatar username="{{task.delegate}}"></glg-avatar>&nbsp;
              </template>
              <template if="{{delegatedToMe(task)}}">
                For&nbsp;<glg-avatar username="{{task.who}}"></glg-avatar>&nbsp;
              </template>
              <span class="{{due(task.when)}}">{{task.when | relativeDate}}</span>
            </row>
            <template if="{{task.done}}">
              <linefeed></linefeed>
              Done {{task.done | relativeDate}}
            </template>
          </column>
        </row>
      </ui-form>
    </preview>
    <full>
      <ui-form on-change="{{saveTodoIfEditing}}">
        <row spaced padded>
          <column>
            <ui-check padded value="{{task.done}}"></ui-check>
          </column>
          <column spaced fill>
            <ui-input placeholder="What?" id="what" multiline="2" value="{{task.what}}">
              <preview>
                <ui-markdown value="{{task.what}}">
                </ui-markdown>
              </preview>
            </ui-input>
            <ui-input placeholder="When?" type="date" value="{{task.when}}" class="{{due(task.when)}}">
              <preview>{{task.when | relativeDate}}</preview>
            </ui-input>
            <template if="{{delegatedToMe(task)}}">
              <row centered>For&nbsp;<glg-avatar username="{{task.who}}"></glg-avatar></row>
            </template>
            <ui-typeahead  placeholder="Delegate To?" value="{{task.delegate}}" valueFilter="{{pluckUsername}}" on-inputchange="{{searchCoworkers}}">
              <template value>
                <value>
                  <glg-avatar micropadded username="{{}}"></glg-avatar>
                </value>
              </template>
              <template repeat="{{coworkers}}">
                <ui-typeahead-item>
                  <glg-avatar username="{{loginName}}"></glg-avatar>
                  <span>{{name}}</span>
                </ui-typeahead-item>
              </template>
            </ui-typeahead>
            <row spaced end>
              <ui-button on-click="{{deleteTodo}}">
                <ui-tooltip>
                  <span tip>Trash This Task</span>
                  <icon trash></icon>
                </ui-tooltip>
              </ui-button>
            </row>
          </column>
        </row>
      </ui-form>
    </full>
  </ui-preview>
</template>
<script src="./glg-task.litcoffee"></script>
</polymer-element>
